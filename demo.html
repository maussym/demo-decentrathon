<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>inDrive Pulse - Urban Mobility Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            color: #845EC2;
        }
        .kpi-label {
            font-size: 1rem;
            font-weight: 500;
            color: #4A5568;
            margin-top: 0.5rem;
        }
        .flowchart-node {
            background-color: #C4FCEF;
            border: 2px solid #00C9A7;
            color: #0d5e50;
            font-weight: 600;
        }
        .flowchart-arrow {
            color: #845EC2;
            font-size: 2rem;
            font-weight: bold;
        }
        #gemini-output {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-style: italic;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #845EC2;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">inDrive Pulse</h1>
            <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥—Å–∫–æ–π –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
            <div class="kpi-card">
                <div class="kpi-value">1.5M+</div>
                <div class="kpi-label">–ê–Ω–æ–Ω–∏–º–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">+18%</div>
                <div class="kpi-label">–ü—Ä–æ–≥–Ω–æ–∑ —Ä–æ—Å—Ç–∞ —Å–ø—Ä–æ—Å–∞</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">-12%</div>
                <div class="kpi-label">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–∞—á–∏</div>
            </div>
        </div>
        
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-2xl font-bold mb-1 text-gray-900">–ö–∞—Ä—Ç–∞ —Å–ø—Ä–æ—Å–∞ –ø–æ —Ä–∞–π–æ–Ω–∞–º</h2>
                <p class="text-gray-600 mb-4">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–≥–æ—Ä—è—á–∏–µ" —Ç–æ—á–∫–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π. –†–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—ä–µ–º—É —Å–ø—Ä–æ—Å–∞ –≤ —É—Å–ª–æ–≤–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö.</p>
                <div class="chart-container h-96 max-h-[500px]">
                    <canvas id="demandHotspotsChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-1 text-gray-900">–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏</h2>
                <p class="text-gray-600 mb-4">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫. –ß–µ—Ç–∫–æ –≤–∏–¥–Ω—ã —É—Ç—Ä–µ–Ω–Ω–∏–µ –∏ –≤–µ—á–µ—Ä–Ω–∏–µ –ø–∏–∫–∏, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –≤–æ–¥–∏—Ç–µ–ª—è—Ö –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.</p>
                <div class="chart-container">
                    <canvas id="peakHoursChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-1 text-gray-900">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
                <p class="text-gray-600 mb-4">–í—ã—è–≤–ª–µ–Ω–∏–µ —Å–∞–º—ã—Ö —á–∞—Å—Ç—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã –≥–æ—Ä–æ–¥–∞ –∏ –≤—ã—è–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ "—É–∑–∫–∏–µ –º–µ—Å—Ç–∞", –≥–¥–µ —á–∞—â–µ –≤—Å–µ–≥–æ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∑–∞–¥–µ—Ä–∂–∫–∏.</p>
                <div class="chart-container">
                    <canvas id="popularRoutesChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-1 text-gray-900">–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–æ–∫</h2>
                <p class="text-gray-600 mb-4">–ú–æ–¥–µ–ª—å –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–µ–∑–¥–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–æ–º–∞–ª–∏–π (—Ä–µ–∑–∫–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞, –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏). –≠—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
                <div class="chart-container">
                    <canvas id="safetyAnalysisChart"></canvas>
                </div>
                <div class="mt-4 flex flex-col items-start space-y-2">
                    <button id="analyzeTripBtn" class="bg-[#FF8066] text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-[#FF664C] transition-colors">–ê–Ω–∞–ª–∏–∑ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏ ‚ú®</button>
                    <div id="gemini-output" class="hidden"></div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-1 text-gray-900">–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤ –ø—Ä–æ–¥—É–∫—Ç</h2>
                <p class="text-gray-600 mb-4">–†–µ—à–µ–Ω–∏–µ "Pulse" –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–∞.</p>
                <div class="space-y-4 mt-6">
                    <div class="flex items-center">
                        <span class="text-3xl mr-4">üöÄ</span>
                        <div>
                            <h3 class="font-bold text-lg">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–∏</h3>
                            <p class="text-gray-600">–ù–∞–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ –∑–æ–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–≥–æ —Å–ø—Ä–æ—Å–∞, —Å–æ–∫—Ä–∞—â–∞—è –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-3xl mr-4">üìà</span>
                        <div>
                            <h3 class="font-bold text-lg">–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                            <p class="text-gray-600">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-3xl mr-4">üõ°Ô∏è</span>
                        <div>
                            <h3 class="font-bold text-lg">–ü–æ–≤—ã—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
                            <p class="text-gray-600">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–ª–∞–≥–∏—Ä—É–µ–º –Ω–µ–æ–±—ã—á–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="summarizeDashboardBtn" class="bg-[#845EC2] text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-[#6e4e9e] transition-colors">–ê—É–¥–∏–æ-—Å–≤–æ–¥–∫–∞ ‚ú®</button>
                    <audio id="audioPlayer" controls class="mt-4 hidden w-full"></audio>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h2>
                 <p class="text-gray-600 mb-6">–û—Ç —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫ —Ü–µ–Ω–Ω—ã–º –∏–Ω—Å–∞–π—Ç–∞–º —Å –ø–æ–ª–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏.</p>
                <div class="flex flex-col md:flex-row items-center justify-around space-y-4 md:space-y-0 md:space-x-4">
                    <div class="text-center">
                        <div class="flowchart-node p-4 rounded-lg shadow">–°—ã—Ä—ã–µ –≥–µ–æ—Ç—Ä–µ–∫–∏</div>
                    </div>
                    <div class="flowchart-arrow transform md:-rotate-0">‚Üì</div>
                    <div class="text-center">
                        <div class="flowchart-node p-4 rounded-lg shadow">–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è (k-anonymity)</div>
                    </div>
                    <div class="flowchart-arrow transform md:-rotate-0">‚Üì</div>
                    <div class="text-center">
                         <div class="flowchart-node p-4 rounded-lg shadow">–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (DBSCAN)</div>
                    </div>
                    <div class="flowchart-arrow transform md:-rotate-0">‚Üì</div>
                    <div class="text-center">
                         <div class="flowchart-node p-4 rounded-lg shadow">–ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</div>
                    </div>
                </div>
            </div>

        </main>

        <footer class="text-center mt-12 text-gray-500">
            <p>&copy; 2025 –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —è–≤–ª—è—é—Ç—Å—è —Å–∏–º—É–ª—è—Ü–∏–µ–π.</p>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const energeticPalette = {
                purple: '#845EC2',
                pink: '#FF8066',
                yellow: '#FFC75F',
                cyan: '#00C9A7',
                lightCyan: '#C4FCEF',
                text: '#2d3748',
                grid: '#e2e8f0'
            };

            const defaultTooltipConfig = {
                callbacks: {
                    title: function(tooltipItems) {
                        const item = tooltipItems[0];
                        let label = item.chart.data.labels[item.dataIndex];
                        if (Array.isArray(label)) {
                            return label.join(' ');
                        } else {
                            return label;
                        }
                    }
                }
            };
            
            function wrapLabel(label, maxWidth = 16) {
                if (typeof label !== 'string' || label.length <= maxWidth) {
                    return label;
                }
                const words = label.split(' ');
                const lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + ' ' + word).trim().length > maxWidth) {
                        lines.push(currentLine.trim());
                        currentLine = word;
                    } else {
                        currentLine = (currentLine + ' ' + word).trim();
                    }
                });
                if (currentLine) {
                    lines.push(currentLine.trim());
                }
                return lines;
            }

            if (document.getElementById('demandHotspotsChart')) {
                const canvas = document.getElementById('demandHotspotsChart');
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: '–¶–µ–Ω—Ç—Ä –ì–æ—Ä–æ–¥–∞',
                            data: [{x: 20, y: 30, r: 25}],
                            backgroundColor: energeticPalette.purple + 'BF'
                        }, {
                            label: '–°–ø–∞–ª—å–Ω—ã–π –†–∞–π–æ–Ω 1',
                            data: [{x: 40, y: 10, r: 18}],
                            backgroundColor: energeticPalette.pink + 'BF'
                        }, {
                            label: '–ë–∏–∑–Ω–µ—Å-–∫–≤–∞—Ä—Ç–∞–ª',
                            data: [{x: 15, y: 50, r: 22}],
                            backgroundColor: energeticPalette.yellow + 'BF'
                        }, {
                            label: '–ü–∞—Ä–∫–æ–≤–∞—è –∑–æ–Ω–∞',
                            data: [{x: 50, y: 55, r: 12}],
                            backgroundColor: energeticPalette.cyan + 'BF'
                        }, {
                            label: '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫',
                            data: [{x: 30, y: 25, r: 15}],
                             backgroundColor: energeticPalette.purple + '8F'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                             x: { display: false },
                             y: { display: false }
                        },
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: defaultTooltipConfig
                        }
                    }
                });
            }
            
            if (document.getElementById('peakHoursChart')) {
                const canvas = document.getElementById('peakHoursChart');
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
                        datasets: [{
                            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–µ–∑–¥–æ–∫',
                            data: [120, 80, 250, 800, 450, 500, 1100, 600],
                            borderColor: energeticPalette.purple,
                            backgroundColor: energeticPalette.purple + '33',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: energeticPalette.grid } }, x: { grid: { color: energeticPalette.grid } } },
                        plugins: {
                             legend: { display: false },
                             tooltip: defaultTooltipConfig
                        }
                    }
                });
            }

            if (document.getElementById('popularRoutesChart')) {
                const canvas = document.getElementById('popularRoutesChart');
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                const ctx = canvas.getContext('2d');
                const rawLabels = [
                    '–¶–µ–Ω—Ç—Ä - –ê—ç—Ä–æ–ø–æ—Ä—Ç',
                    '–°–ø–∞–ª—å–Ω—ã–π –†–∞–π–æ–Ω 1 - –ë–∏–∑–Ω–µ—Å-–∫–≤–∞—Ä—Ç–∞–ª',
                    '–í–æ–∫–∑–∞–ª - –¶–µ–Ω—Ç—Ä',
                    '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç - –°–ø–∞–ª—å–Ω—ã–π –†–∞–π–æ–Ω 2',
                    '–¢–¶ –ú–µ–≥–∞ - –ü–∞—Ä–∫ –ö—É–ª—å—Ç—É—Ä—ã'
                ];

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: rawLabels.map(l => wrapLabel(l)),
                        datasets: [{
                            label: '–ß–∞—Å—Ç–æ—Ç–∞',
                            data: [1250, 980, 850, 720, 610],
                            backgroundColor: [
                                energeticPalette.purple,
                                energeticPalette.pink,
                                energeticPalette.yellow,
                                energeticPalette.cyan,
                                energeticPalette.purple + '99',
                            ],
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { color: energeticPalette.grid } },
                            y: { grid: { display: false } }
                        },
                        plugins: {
                             legend: { display: false },
                             tooltip: defaultTooltipConfig
                        }
                    }
                });
            }
            
            if (document.getElementById('safetyAnalysisChart')) {
                const canvas = document.getElementById('safetyAnalysisChart');
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ', '–ê–Ω–æ–º–∞–ª—å–Ω—ã–µ'],
                        datasets: [{
                            data: [98.5, 1.5],
                            backgroundColor: [energeticPalette.cyan, energeticPalette.pink],
                            borderColor: '#ffffff',
                            borderWidth: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                             legend: { position: 'bottom' },
                             tooltip: defaultTooltipConfig
                        }
                    }
                });
            }

            const analyzeTripBtn = document.getElementById('analyzeTripBtn');
            const summarizeDashboardBtn = document.getElementById('summarizeDashboardBtn');
            const geminiOutput = document.getElementById('gemini-output');
            const audioPlayer = document.getElementById('audioPlayer');

            const API_KEY = "";

            const showLoading = (el) => {
                el.innerHTML = '<div class="spinner"></div>';
                el.classList.remove('hidden');
            };

            const hideLoading = (el) => {
                el.innerHTML = '';
                el.classList.add('hidden');
            };

            const convertBase64ToWav = (base64Data) => {
                const pcmData = atob(base64Data);
                const arrayBuffer = new ArrayBuffer(pcmData.length);
                const view = new Uint8Array(arrayBuffer);
                for (let i = 0; i < pcmData.length; i++) {
                    view[i] = pcmData.charCodeAt(i);
                }
                const sampleRate = 16000;
                const pcm16 = new Int16Array(arrayBuffer);
                const buffer = new ArrayBuffer(44 + pcm16.length * 2);
                const view8 = new DataView(buffer);
                
                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }

                writeString(view8, 0, 'RIFF');
                view8.setUint32(4, 36 + pcm16.length * 2, true);
                writeString(view8, 8, 'WAVE');
                writeString(view8, 12, 'fmt ');
                view8.setUint32(16, 16, true);
                view8.setUint16(20, 1, true);
                view8.setUint16(22, 1, true);
                view8.setUint32(24, sampleRate, true);
                view8.setUint32(28, sampleRate * 2, true);
                view8.setUint16(32, 2, true);
                view8.setUint16(34, 16, true);
                writeString(view8, 36, 'data');
                view8.setUint32(40, pcm16.length * 2, true);
                
                for (let i = 0; i < pcm16.length; i++) {
                    view8.setInt16(44 + i * 2, pcm16[i], true);
                }

                return new Blob([view8], { type: 'audio/wav' });
            };

            analyzeTripBtn.addEventListener('click', async () => {
                showLoading(geminiOutput);
                const mockTripData = {
                    start: '–£–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 15',
                    end: '–£–ª–∏—Ü–∞ –ü—É—à–∫–∏–Ω–∞, 37',
                    duration: '25 –º–∏–Ω—É—Ç',
                    distance: '7.8 –∫–º',
                    deviations: '2 –±–æ–ª—å—à–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞',
                    speed: '—Ä–µ–∑–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏',
                    stops: '–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ 10 –º–∏–Ω—É—Ç –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º –º–µ—Å—Ç–µ'
                };
                
                const prompt = `–ö–∞–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –ø–æ–µ–∑–¥–∫—É –∏ –æ–±—ä—è—Å–Ω–∏—Ç–µ, –ø–æ—á–µ–º—É –æ–Ω–∞ –º–æ–∂–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –∞–Ω–æ–º–∞–ª—å–Ω–æ–π, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö:
                - –ù–∞—á–∞–ª–æ: ${mockTripData.start}
                - –ö–æ–Ω–µ—Ü: ${mockTripData.end}
                - –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${mockTripData.duration}
                - –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${mockTripData.distance}
                - –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: ${mockTripData.deviations}
                - –°–∫–æ—Ä–æ—Å—Ç—å: ${mockTripData.speed}
                - –û—Å—Ç–∞–Ω–æ–≤–∫–∏: ${mockTripData.stops}
                –°–¥–µ–ª–∞–π—Ç–µ –≤—ã–≤–æ–¥, —É–∫–∞–∑–∞–≤ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –∞–Ω–æ–º–∞–ª–∏–∏.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "–í—ã –æ–ø—ã—Ç–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏." }] },
                        })
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑.";
                    geminiOutput.innerHTML = `<p>${text}</p>`;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ Gemini API:', error);
                    geminiOutput.innerHTML = `<p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–æ–µ–∑–¥–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>`;
                } finally {
                    hideLoading(geminiOutput);
                    geminiOutput.classList.remove('hidden');
                }
            });

            summarizeDashboardBtn.addEventListener('click', async () => {
                showLoading(summarizeDashboardBtn);
                audioPlayer.classList.add('hidden');
                audioPlayer.pause();
                
                const prompt = "–î–∞–π—Ç–µ —á–µ—Ç–∫—É—é –∏ –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º —ç—Ç–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤, –ø—Ä–æ–≥–Ω–æ–∑ —Ä–æ—Å—Ç–∞ —Å–ø—Ä–æ—Å–∞ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–∞—á–∏. –ó–∞—Ç–µ–º –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –ø–∏–∫–æ–≤—ã—Ö —á–∞—Å–æ–≤, –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: {
                                    voiceConfig: {
                                        prebuiltVoiceConfig: { voiceName: "Rasalgethi" }
                                    }
                                }
                            },
                            model: "gemini-2.5-flash-preview-tts"
                        })
                    });

                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ API');
                    
                    const result = await response.json();
                    const audioPart = result?.candidates?.[0]?.content?.parts?.[0];

                    if (audioPart && audioPart.inlineData && audioPart.inlineData.data) {
                        const audioData = audioPart.inlineData.data;
                        const wavBlob = convertBase64ToWav(audioData);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        audioPlayer.src = audioUrl;
                        audioPlayer.classList.remove('hidden');
                        audioPlayer.play();
                    } else {
                        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ.");
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ TTS API:', error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É–¥–∏–æ-—Å–≤–æ–¥–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
                } finally {
                    hideLoading(summarizeDashboardBtn);
                }
            });

        });
    </script>
</body>
</html>
